<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script type="text/javascript" src="http://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
<style type="text/css">
    #box1{
        width: 44px;
        height:44px;
        position: absolute;
        background: rgb(92, 177, 230);
    }
    body{
      margin:0 auto;
      max-width: 50em;
      font-family: "Times New Roman", "arial", sans-serif;
    }
</style>
<script type="text/javascript" type="text/javascript">
  // Connecting to ROS
  var ros = new ROSLIB.Ros({
    url : 'ws://192.168.43.183:9090'
  });
   
  var isconected=false;

  //åˆ¤æ–­æ˜¯å¦è¿æ¥æˆåŠŸå¹¶è¾“å‡ºç›¸åº”çš„æç¤ºæ¶ˆæ¯åˆ°webæ§åˆ¶å°
  ros.on('connection', function() {
    isconected=true;
    console.log('Connected to websocket server.');
    subscribe();
  }); 

  ros.on('error', function(error) {
    isconected=false;
    console.log('Error connecting to websocket server: ', error);
  });
  
  ros.on('close', function() {
    isconected=false;
    console.log('Connection to websocket server closed.');
    unsubscribe();
  });

  // Publishing a Topic
  var cmdVel = new ROSLIB.Topic({
    ros : ros,
    name : '/servo',
    messageType : 'geometry_msgs/Twist'
  });//åˆ›å»ºä¸€ä¸ªtopic,å®ƒçš„åå­—æ˜¯'/cmd_vel',,æ¶ˆæ¯ç±»å‹æ˜¯'geometry_msgs/Twist' 

  var twist = new ROSLIB.Message({
    linear : {
      x : 0.0,
      y : 0.0,
      z : 0.0
    },
    angular : {
      x : 0.0,
      y : 0.0,
      z : 0.0
    }
  });//åˆ›å»ºä¸€ä¸ªmessage
    
  function control_move(direction){
    twist.linear.x = 0.0;
    twist.linear.y = 0;
    twist.linear.z = 0;
    twist.angular.x = 0;
    twist.angular.y = 0;
    twist.angular.z = 0.0;
    
    switch(direction){
      case 'up':
        twist.linear.x = 20;
        break;
      case 'down':
        twist.linear.x = 50;
      break;
      case 'left':
        twist.linear.x = 100;
      break;
      case 'right':
        twist.linear.x = 150;
      break;
      case 'stop':
        twist.linear.x = 0;
      break;
    }
    cmdVel.publish(twist);//å‘å¸ƒtwistæ¶ˆæ¯
  }

  var timer=null;    
  function buttonmove(){    
    var oUp=document.getElementById('up');
    var oDown=document.getElementById('down');
    var oLeft=document.getElementById('left');
    var oRight=document.getElementById('right');
    var oStop=document.getElementById('stop');
         
    oUp.onmousedown=function ()
    {
        Move('up');        
    }
    oDown.onmousedown=function ()
    {
        Move('down');        
    }
     
    oLeft.onmousedown=function ()
    {
        Move('left');        
    }
     
    oRight.onmousedown=function ()
    {
        Move('right');       
    }

    oStop.onmouseup=function ()
    {
      Move('stop');
      //è¿™é‡Œåº”è¯¥æŒ‡å®šstopå‘½ä»¤å¦ï¼Ÿ
    }

    oUp.onmouseup=oDown.onmouseup=oLeft.onmouseup=oRight.onmouseup=function ()
    {
        MouseUp ();
    }      
  }


  function keymove (event) {    
    event = event || window.event;/*||ä¸ºæˆ–è¯­å¥ï¼Œå½“IEä¸èƒ½è¯†åˆ«eventæ—¶å€™ï¼Œå°±æ‰§è¡Œwindow.event èµ‹å€¼*/
    console.log(event.keyCode);
    switch (event.keyCode){
        /*keyCode:å­—æ¯å’Œæ•°å­—é”®çš„é”®ç å€¼*/          
        /*65,87,68,83åˆ†åˆ«å¯¹åº”awds*/
        case 65:                 
            Move('left');
            break;
        case 87:              
            Move('up');
            break;
        case 68:              
            Move('right');
            break;
        case 83:
            Move('down');
            break;
        default:
            break;
    }
  }

  var MoveTime=20;
     
  function Move (f){
    clearInterval(timer);
      
    timer=setInterval(function (){          
      control_move(f)      
    },MoveTime);
  }        
       
  function MouseUp ()
  {
      clearInterval(timer);        
  }
  
  function KeyUp(event){
      MouseUp();
  }
  window.onload=function ()
  {  
        buttonmove();                
        document.onkeyup=KeyUp;
        document.onkeydown=keymove;           
        Movebox();    
  }
  
  // Subscribing to a Topic
  var listener = new ROSLIB.Topic({
    ros : ros,
    name : '/turtle1/pose',
    messageType : 'turtlesim/Pose'
  });//åˆ›å»ºä¸€ä¸ªtopic,å®ƒçš„åå­—æ˜¯'/turtle1/pose',,æ¶ˆæ¯ç±»å‹æ˜¯'turtlesim/Pose',ç”¨äºæ¥æ”¶ä¹Œé¾Ÿä½ç½®ä¿¡æ¯
 
  var turtle_x=0.0;
  var turtle_y=0.0;
  
  function subscribe()//åœ¨è¿æ¥æˆåŠŸåï¼Œæ§åˆ¶divçš„ä½ç½®ï¼Œ
  {
     listener.subscribe(function(message) {         
       turtle_x=message.x;
       turtle_y=message.y;
       document.getElementById("output").innerHTML = ('Received message on ' + listener.name +'  x: ' + message.x+" ,y: "+message.y);
     });
  } 

  function unsubscribe()//åœ¨æ–­å¼€è¿æ¥åï¼Œå–æ¶ˆè®¢é˜…
  {
     listener.unsubscribe();    
  }
    
  function Movebox ()
  {    
    var obox=document.getElementById("box1");    
    var timer=null;
    
    clearInterval(timer);
         
    timer=setInterval(function (){
      if(!isconected)
      {
        obox.style.left = '0px';
        obox.style.top = '0px';        
      } else {
        obox.style.left =Math.round(60*turtle_x)-330+"px";
        console.log(obox.style.left)
        obox.style.top =330-Math.round(60*turtle_y)+"px";
        console.log(obox.style.top)
      }
    },20);
 }

</script>
</head>

<div id="app">
  <h4>è°ƒæŸ¥æ»¡æ„åº¦</h4>
  <p>å½“å‰ğŸ‘ï¼š{{counter}}</p>
  <button v-on:click="addition">ğŸ‘</button>
  <button v-on:click="subtraction">ğŸ‘</button>
</div>

<body>

  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script>
    const app = new Vue({
      el:'#app',
      data:{
        counter:0
      },
      methods:{
        addition:function(){
          console.log('additionè¢«æ‰§è¡Œ');
          this.counter++;
        },
        subtraction:function(){
          console.log('subtractionè¢«æ‰§è¡Œ')
          this.counter--;
        }
      }
    });
  </script>


  <h1>Rosbridge æ ·ä¾‹</h1>
  <h2>Move turtle with teleop or button</h2>
  <h3>First</h3>
  <p>on robot machine,run: roslaunch rosbridge_server rosbridge_websocket.launch</p>
  <h3>Second</h3>
  <p>on robot machine,run: rosrun turtlesim turtlesim_node</p>
  <h3>Third</h3>
  <p>on this webpage control turtle with up,down,left,right key</p>
  <p>Check your Web Console for output.</p>

  <input type="button" value="å‰è¡Œ" id="up">
  <input type="button" value="åé€€" id="down">
  <input type="button" value="å·¦è½¬" id="left">
  <input type="button" value="å³è½¬" id="right">
  <input type="button" value="åœæ­¢" id="stop">

  <h3>Team:å‘¨-æ¢“-é¸£</h3>
  <p id = "output"></p>

  <div id="mbox" style="width:704px;height:704px;border:1px solid red;position: relative;">
    <div id="box1" style="margin-left:330px;margin-top:330px;position:absolute;" ></div>    
  </div>
</body>
</html>


